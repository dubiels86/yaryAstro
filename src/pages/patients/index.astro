---
import MainLayout from "@/layouts/MainLayout.astro";
---

<MainLayout>
  <section class="py-12 bg-gray-50 dark:bg-slate-900">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h1 class="text-xl font-bold text-gray-900 dark:text-white sm:text-5xl">
          Pacientes
        </h1>
      </div>

      <!-- Botón para agregar nuevo paciente -->
      <div class="mt-8 flex justify-end">
        <button
          type="button"
          class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-yellow-500 hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500"
          id="addPatientBtn"
        >
          <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
          </svg>
          Nuevo Paciente
        </button>
      </div>

      <!-- Tabla de pacientes -->
      <div class="mt-8 flex flex-col">
        <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
          <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
            <div class="shadow overflow-hidden border-b border-gray-200 dark:border-gray-700 sm:rounded-lg">
              <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-slate-800">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Nombre
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Edad
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Diagnóstico
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Última Cita
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                      Acciones
                    </th>
                  </tr>
                </thead>
                <tbody class="bg-white dark:bg-slate-900 divide-y divide-gray-200 dark:divide-gray-700" id="patientsTableBody">
                  <!-- Los datos se cargarán dinámicamente con JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal para agregar/editar paciente -->
  <div id="patientModal" class="hidden fixed z-10 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
      <div class="inline-block align-bottom bg-white dark:bg-slate-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <form id="patientForm" class="p-6">
          <div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title">
              Nuevo Paciente
            </h3>
            <div class="mt-4 space-y-4">
              <div>
                <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nombre Completo</label>
                <input type="text" name="name" id="name" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-yellow-500 focus:ring-yellow-500 dark:bg-slate-700 dark:text-white sm:text-sm">
              </div>
              <div>
                <label for="age" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Edad</label>
                <input type="number" name="age" id="age" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-yellow-500 focus:ring-yellow-500 dark:bg-slate-700 dark:text-white sm:text-sm">
              </div>
              <div>
                <label for="diagnosis" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Diagnóstico</label>
                <textarea name="diagnosis" id="diagnosis" rows="3" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-yellow-500 focus:ring-yellow-500 dark:bg-slate-700 dark:text-white sm:text-sm"></textarea>
              </div>
              <div>
                <label for="lastVisit" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Prox. Cita</label>
                <input type="date" name="lastVisit" id="lastVisit" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-yellow-500 focus:ring-yellow-500 dark:bg-slate-700 dark:text-white sm:text-sm">
              </div>
            </div>
          </div>
          <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
            <button
              type="submit"
              class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-yellow-500 text-base font-medium text-white hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 sm:col-start-2 sm:text-sm"
            >
              Guardar
            </button>
            <button
              type="button"
              class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-slate-700 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 sm:mt-0 sm:col-start-1 sm:text-sm"
              id="cancelBtn"
            >
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</MainLayout>

<script>
  // Datos de ejemplo
  let patients = [
    {
      id: 1,
      name: "María González",
      age: 45,
      diagnosis: "Diabetes Tipo 2",
      lastVisit: "2024-03-15"
    },
    {
      id: 2,
      name: "Juan Pérez",
      age: 38,
      diagnosis: "Hipotiroidismo",
      lastVisit: "2024-03-10"
    }
  ];

  // Elementos del DOM
  const modal = document.getElementById('patientModal');
  const addPatientBtn = document.getElementById('addPatientBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const patientForm = document.getElementById('patientForm') as HTMLFormElement;
  const tableBody = document.getElementById('patientsTableBody');

  // Funciones
  function renderPatients() {
    if (!tableBody) return;
    tableBody.innerHTML = patients.map(patient => `
      <tr>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
          ${patient.name}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
          ${patient.age}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
          ${patient.diagnosis}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
          ${patient.lastVisit}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
          <button onclick="editPatient(${patient.id})" class="text-yellow-500 hover:text-yellow-600 mr-3">
            Editar
          </button>
          <button onclick="deletePatient(${patient.id})" class="text-red-500 hover:text-red-600">
            Eliminar
          </button>
        </td>
      </tr>
    `).join('');
  }

  function showModal() {
    if (!modal) return;
    modal.classList.remove('hidden');
  }

  function hideModal() {
    if (!modal || !patientForm) return;
    modal.classList.add('hidden');
    patientForm.reset();
  }

  function addPatient(e: Event) {
    e.preventDefault();
    if (!patientForm) return;
    const formData = new FormData(patientForm);
    const newPatient = {
      id: patients.length + 1,
      name: formData.get('name') as string,
      age: parseInt(formData.get('age') as string),
      diagnosis: formData.get('diagnosis') as string,
      lastVisit: formData.get('lastVisit') as string
    };
    patients.push(newPatient);
    renderPatients();
    hideModal();
  }

  function editPatient(id: number) {
    const patient = patients.find(p => p.id === id);
    if (!patient) return;
    
    const nameInput = document.getElementById('name') as HTMLInputElement;
    const ageInput = document.getElementById('age') as HTMLInputElement;
    const diagnosisInput = document.getElementById('diagnosis') as HTMLTextAreaElement;
    const lastVisitInput = document.getElementById('lastVisit') as HTMLInputElement;

    if (nameInput && ageInput && diagnosisInput && lastVisitInput) {
      nameInput.value = patient.name;
      ageInput.value = patient.age.toString();
      diagnosisInput.value = patient.diagnosis;
      lastVisitInput.value = patient.lastVisit;
      showModal();
    }
  }

  function deletePatient(id: number) {
    if (confirm('¿Está seguro de eliminar este paciente?')) {
      patients = patients.filter(p => p.id !== id);
      renderPatients();
    }
  }

  // Event Listeners
  addPatientBtn?.addEventListener('click', showModal);
  cancelBtn?.addEventListener('click', hideModal);
  patientForm?.addEventListener('submit', addPatient);

  // Renderizar pacientes iniciales
  renderPatients();
</script> 